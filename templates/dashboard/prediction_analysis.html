{% extends 'base.html' %}
{% load static %}

{% block title %}Prediction Analysis - Zinara System{% endblock %}

{% block extra_head %}
<style>
    .stat-card {
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .insight-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .risk-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
    }
    /* All chart cards should match Recent Alerts card size - FIXED SIZE - NO GROWING */
    .chart-card, .equal-card {
        height: 400px !important;
        max-height: 400px !important;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .chart-container {
        position: relative;
        height: 280px !important;
        max-height: 280px !important;
        width: 100%;
        margin: 0 auto;
        padding: 0;
        flex-shrink: 0;
        overflow: hidden;
    }
    
    .chart-card .card-body, .equal-card .card-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 1.5rem;
    }
    
    .chart-card canvas, .equal-card canvas {
        max-height: 280px !important;
        height: 280px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-chart-line text-primary"></i> Prediction Analysis Report</h2>
        <p class="text-muted">Comprehensive analysis of vehicle license compliance predictions</p>
    </div>
</div>

<!-- Model Information Card -->
{% if active_model %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-brain"></i> Active ML Model Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Model Name:</strong><br>
                        <span class="badge bg-info">{{ model_name }}</span>
                    </div>
                    <div class="col-md-2">
                        <strong>Model Type:</strong><br>
                        <span class="badge bg-secondary">{{ model_type|upper }}</span>
                    </div>
                    <div class="col-md-2">
                        <strong>Accuracy:</strong><br>
                        <span class="badge bg-success">{{ model_accuracy|floatformat:3|default:"N/A" }}</span>
                    </div>
                    <div class="col-md-2">
                        <strong>F1 Score:</strong><br>
                        <span class="badge bg-warning">{{ model_f1|floatformat:3|default:"N/A" }}</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Trained:</strong><br>
                        <small>{{ model_trained_date|date:"M d, Y H:i"|default:"N/A" }}</small>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            This analysis uses predictions from the trained {{ model_type|upper }} model. 
                            The model analyzes vehicle data and predicts the likelihood of license non-compliance.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if error %}
<div class="alert alert-danger">
    <i class="fas fa-exclamation-circle"></i> {{ error }}
</div>
{% elif has_model and has_data %}

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card bg-primary text-white">
            <h3>{{ total_vehicles|default:0 }}</h3>
            <p class="mb-0"><i class="fas fa-car"></i> Total Vehicles Analyzed</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-danger text-white">
            <h3>{{ high_risk_count|default:0 }}</h3>
            <p class="mb-0"><i class="fas fa-exclamation-triangle"></i> High Risk Vehicles</p>
            <small>{{ high_risk_percent|default:0 }}% of total</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-warning text-white">
            <h3>{{ medium_risk_count|default:0 }}</h3>
            <p class="mb-0"><i class="fas fa-exclamation-circle"></i> Medium Risk Vehicles</p>
            <small>{{ medium_risk_percent|default:0 }}% of total</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-success text-white">
            <h3>{{ low_risk_count|default:0 }}</h3>
            <p class="mb-0"><i class="fas fa-check-circle"></i> Low Risk Vehicles</p>
            <small>{{ low_risk_percent|default:0 }}% of total</small>
        </div>
    </div>
</div>

<!-- Key Insights -->
{% if insights %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-lightbulb"></i> Key Insights</h5>
            </div>
            <div class="card-body">
                {% for insight in insights %}
                <div class="insight-card">
                    {{ insight }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Risk Distribution Chart -->
<div class="row mb-4 g-4">
    <div class="col-md-6 d-flex">
        <div class="card chart-card equal-card w-100">
            <div class="card-header">
                <h5>Risk Distribution</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="riskDistributionChart" height="280"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 d-flex">
        <div class="card chart-card equal-card w-100">
            <div class="card-header">
                <h5>Average Risk Score by Region</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="regionalRiskChart" height="280"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vehicle Type Analysis -->
<div class="row mb-4 g-4">
    <div class="col-12 d-flex">
        <div class="card chart-card equal-card w-100">
            <div class="card-header">
                <h5>Risk Analysis by Vehicle Type</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="vehicleTypeRiskChart" height="280"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Mode Analysis -->
<div class="row mb-4 g-4">
    <div class="col-12 d-flex">
        <div class="card chart-card equal-card w-100">
            <div class="card-header">
                <h5>Risk Analysis by Payment Mode</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="paymentModeChart" height="280"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Top High-Risk Vehicles -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-exclamation-triangle"></i> Top 20 High-Risk Vehicles</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Vehicle ID</th>
                                <th>Type</th>
                                <th>Region</th>
                                <th>Risk Score</th>
                                <th>Prediction</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vehicle in high_risk_vehicles %}
                            <tr>
                                <td><strong>{{ vehicle.vehicle_id }}</strong></td>
                                <td>{{ vehicle.vehicle_type|default:"N/A" }}</td>
                                <td>{{ vehicle.region|default:"N/A" }}</td>
                                <td>
                                    <span class="badge bg-{% if vehicle.risk_score > 0.7 %}danger{% elif vehicle.risk_score > 0.4 %}warning{% else %}success{% endif %}">
                                        {{ vehicle.risk_score|floatformat:3 }}
                                    </span>
                                </td>
                                <td>
                                    {% if vehicle.predicted_unlicensed %}
                                    <span class="badge bg-danger">High Risk</span>
                                    {% else %}
                                    <span class="badge bg-success">Low Risk</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <a href="{% url 'dashboard:risk_analysis' %}?risk_level=high" class="btn btn-danger">
                        <i class="fas fa-list"></i> View All High-Risk Vehicles
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Items -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-tasks"></i> Recommended Actions</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <i class="fas fa-check-circle text-success"></i> 
                        Contact owners of <strong>{{ high_risk_count }}</strong> high-risk vehicles to encourage license renewal
                    </li>
                    <li class="list-group-item">
                        <i class="fas fa-check-circle text-success"></i> 
                        Focus outreach efforts on regions with highest risk scores
                    </li>
                    <li class="list-group-item">
                        <i class="fas fa-check-circle text-success"></i> 
                        Consider incentives for vehicles using payment modes with lower compliance rates
                    </li>
                    <li class="list-group-item">
                        <i class="fas fa-check-circle text-success"></i> 
                        Schedule follow-up analysis in 30 days to track improvements
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> 
    Please ensure a model is trained and activated, and the dataset is available.
    <a href="{% url 'ml_models:model_list' %}" class="alert-link">Go to ML Models</a>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if has_model and has_data %}
    // Risk Distribution Pie Chart
    const riskDistData = {{ risk_distribution|safe }};
    const riskDistCtx = document.getElementById('riskDistributionChart').getContext('2d');
    new Chart(riskDistCtx, {
        type: 'doughnut',
        data: {
            labels: ['Low Risk', 'Medium Risk', 'High Risk'],
            datasets: [{
                data: [riskDistData.low, riskDistData.medium, riskDistData.high],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 10,
                    bottom: 10
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 10,
                        font: {
                            size: 11,
                            weight: '500'
                        },
                        boxWidth: 12
                    }
                },
                tooltip: {
                    padding: 10,
                    titleFont: {
                        size: 12,
                        weight: '600'
                    },
                    bodyFont: {
                        size: 11
                    }
                }
            }
        }
    });

    // Regional Risk Chart
    const regionalData = {{ regional_analysis|safe }};
    const regionalCtx = document.getElementById('regionalRiskChart').getContext('2d');
    new Chart(regionalCtx, {
        type: 'bar',
        data: {
            labels: regionalData.map(r => r.region || 'Unknown'),
            datasets: [{
                label: 'Average Risk Score',
                data: regionalData.map(r => r.avg_risk || 0),
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: '600'
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1.0,
                    ticks: {
                        font: {
                            size: 10
                        },
                        padding: 5,
                        maxTicksLimit: 6
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 10
                        },
                        padding: 5,
                        maxRotation: 45,
                        minRotation: 0
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Vehicle Type Risk Chart
    const vehicleTypeData = {{ vehicle_type_analysis|safe }};
    const vehicleTypeCtx = document.getElementById('vehicleTypeRiskChart').getContext('2d');
    new Chart(vehicleTypeCtx, {
        type: 'bar',
        data: {
            labels: vehicleTypeData.map(v => v.vehicle_type || 'Unknown'),
            datasets: [{
                label: 'Average Risk Score',
                data: vehicleTypeData.map(v => v.avg_risk || 0),
                backgroundColor: 'rgba(255, 99, 132, 0.8)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: '600'
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1.0,
                    ticks: {
                        font: {
                            size: 10
                        },
                        padding: 5,
                        maxTicksLimit: 6
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 10
                        },
                        padding: 5,
                        maxRotation: 45,
                        minRotation: 0
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Payment Mode Chart
    const paymentData = {{ payment_analysis|safe }};
    const paymentCtx = document.getElementById('paymentModeChart').getContext('2d');
    new Chart(paymentCtx, {
        type: 'bar',
        data: {
            labels: paymentData.map(p => p.payment_mode || 'Unknown'),
            datasets: [{
                label: 'Average Risk Score',
                data: paymentData.map(p => p.avg_risk || 0),
                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: '600'
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1.0,
                    ticks: {
                        font: {
                            size: 10
                        },
                        padding: 5,
                        maxTicksLimit: 6
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 10
                        },
                        padding: 5,
                        maxRotation: 45,
                        minRotation: 0
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}

