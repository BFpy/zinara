{% extends 'base.html' %}
{% load static %}

{% block title %}How It Works - Zinara System{% endblock %}

{% block extra_head %}
<style>
    .step-card {
        border-left: 4px solid #007bff;
        margin-bottom: 20px;
        transition: transform 0.2s;
    }
    .step-card:hover {
        transform: translateX(5px);
    }
    .feature-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-question-circle text-primary"></i> How the Prediction Model Works</h2>
        <p class="text-muted">Understanding our machine learning approach to vehicle license compliance prediction</p>
    </div>
</div>

<!-- Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-info-circle"></i> Overview</h5>
            </div>
            <div class="card-body">
                <p class="lead">
                    Our system uses advanced machine learning to predict which vehicles are at risk of license non-compliance. 
                    This helps us proactively identify vehicles that may need attention and allows us to take preventive action.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- System Flow -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-sitemap"></i> System Flow: How the Trained Model is Used</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-2">
                        <div class="card bg-light">
                            <div class="card-body">
                                <i class="fas fa-database fa-2x text-primary mb-2"></i>
                                <p class="mb-0"><strong>1. Database</strong></p>
                                <small>Vehicle data loaded</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1 text-center align-self-center">
                        <i class="fas fa-arrow-right fa-2x text-muted"></i>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-light">
                            <div class="card-body">
                                <i class="fas fa-file-code fa-2x text-success mb-2"></i>
                                <p class="mb-0"><strong>2. Load Model</strong></p>
                                <small>Trained model loaded from disk</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1 text-center align-self-center">
                        <i class="fas fa-arrow-right fa-2x text-muted"></i>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-light">
                            <div class="card-body">
                                <i class="fas fa-brain fa-2x text-warning mb-2"></i>
                                <p class="mb-0"><strong>3. Predict</strong></p>
                                <small>Model makes predictions</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1 text-center align-self-center">
                        <i class="fas fa-arrow-right fa-2x text-muted"></i>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-light">
                            <div class="card-body">
                                <i class="fas fa-chart-bar fa-2x text-danger mb-2"></i>
                                <p class="mb-0"><strong>4. Reports</strong></p>
                                <small>Generate insights & charts</small>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> 
                    <strong>Yes, the system uses the trained model!</strong> When you run Prediction Analysis or Risk Analysis, 
                    the system automatically loads the active trained model from the database and uses it to make predictions 
                    on all vehicles in your dataset. The predictions are then displayed in comprehensive reports with charts and insights.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- How It Works Steps -->
<div class="row mb-4">
    <div class="col-12">
        <h4><i class="fas fa-cogs"></i> How It Works</h4>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card step-card">
            <div class="card-body">
                <h5><span class="badge bg-primary">1</span> Data Collection</h5>
                <p>
                    We collect comprehensive data about each vehicle including:
                </p>
                <ul>
                    <li>Vehicle type and age</li>
                    <li>License renewal history</li>
                    <li>Payment preferences</li>
                    <li>Geographic location</li>
                    <li>Previous compliance records</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card step-card">
            <div class="card-body">
                <h5><span class="badge bg-primary">2</span> Feature Engineering</h5>
                <p>
                    We analyze the data to create predictive features:
                </p>
                <ul>
                    <li>Days since last renewal</li>
                    <li>Number of late renewals</li>
                    <li>Average renewal delay</li>
                    <li>Regional risk factors</li>
                    <li>Payment mode patterns</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card step-card">
            <div class="card-body">
                <h5><span class="badge bg-primary">3</span> Machine Learning Model</h5>
                <p>
                    Our XGBoost model analyzes all these features to predict:
                </p>
                <ul>
                    <li><strong>Risk Score:</strong> A probability (0-1) indicating likelihood of non-compliance</li>
                    <li><strong>Prediction:</strong> Whether the vehicle is predicted to be non-compliant</li>
                    <li><strong>Confidence:</strong> How certain the model is about its prediction</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card step-card">
            <div class="card-body">
                <h5><span class="badge bg-primary">4</span> Risk Categorization</h5>
                <p>
                    Vehicles are categorized based on their risk scores:
                </p>
                <ul>
                    <li><span class="badge bg-success">Low Risk</span> (0.0 - 0.4): Likely to remain compliant</li>
                    <li><span class="badge bg-warning">Medium Risk</span> (0.4 - 0.7): May need attention</li>
                    <li><span class="badge bg-danger">High Risk</span> (0.7 - 1.0): Requires immediate action</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Key Features -->
<div class="row mb-4">
    <div class="col-12">
        <h4><i class="fas fa-star"></i> Key Predictive Features</h4>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="feature-box">
            <h6><i class="fas fa-calendar text-primary"></i> Temporal Features</h6>
            <ul class="small">
                <li>Days since last renewal</li>
                <li>Number of late renewals</li>
                <li>Average renewal lag</li>
                <li>Time of year (seasonality)</li>
            </ul>
        </div>
    </div>
    <div class="col-md-4">
        <div class="feature-box">
            <h6><i class="fas fa-map-marker-alt text-success"></i> Geographic Features</h6>
            <ul class="small">
                <li>Region (Urban/Peri-urban/Rural)</li>
                <li>Regional compliance rates</li>
                <li>Regional risk scores</li>
            </ul>
        </div>
    </div>
    <div class="col-md-4">
        <div class="feature-box">
            <h6><i class="fas fa-credit-card text-warning"></i> Behavioral Features</h6>
            <ul class="small">
                <li>Preferred payment mode</li>
                <li>Payment digitalization score</li>
                <li>Agent synchronization lag</li>
                <li>Compliance history</li>
            </ul>
        </div>
    </div>
</div>

<!-- Model Performance -->
{% if active_model %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-chart-line"></i> Current Model Performance</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-primary">{{ active_model.accuracy|floatformat:2|default:"N/A" }}</h3>
                            <p class="text-muted">Accuracy</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-success">{{ active_model.precision|floatformat:2|default:"N/A" }}</h3>
                            <p class="text-muted">Precision</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-info">{{ active_model.recall|floatformat:2|default:"N/A" }}</h3>
                            <p class="text-muted">Recall</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-warning">{{ active_model.f1_score|floatformat:2|default:"N/A" }}</h3>
                            <p class="text-muted">F1 Score</p>
                        </div>
                    </div>
                </div>
                <hr>
                <p class="mb-0">
                    <strong>Active Model:</strong> {{ active_model.name }} ({{ active_model.model_type|upper }})
                    <br>
                    <small class="text-muted">Trained on {{ active_model.training_data_size|default:"N/A" }} vehicles</small>
                </p>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> No active model found. Please train a model first.
            <a href="{% url 'ml_models:model_list' %}" class="alert-link">Go to ML Models</a>
        </div>
    </div>
</div>
{% endif %}

<!-- Benefits -->
<div class="row mb-4">
    <div class="col-12">
        <h4><i class="fas fa-check-circle text-success"></i> Benefits</h4>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6><i class="fas fa-bullseye text-primary"></i> Proactive Intervention</h6>
                <p class="small">
                    Identify vehicles at risk before they become non-compliant, allowing for timely intervention.
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6><i class="fas fa-chart-pie text-success"></i> Data-Driven Decisions</h6>
                <p class="small">
                    Make informed decisions based on comprehensive risk analysis and predictive insights.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6><i class="fas fa-money-bill-wave text-warning"></i> Resource Optimization</h6>
                <p class="small">
                    Focus outreach efforts on high-risk vehicles, optimizing resource allocation.
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6><i class="fas fa-trending-up text-info"></i> Improved Compliance</h6>
                <p class="small">
                    Increase overall compliance rates by addressing issues before they escalate.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Next Steps -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-arrow-right"></i> Next Steps</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li><strong>Run Prediction Analysis:</strong> Analyze your database to identify vehicles at risk</li>
                    <li><strong>Review Risk Analysis:</strong> Examine high-risk vehicles and their characteristics</li>
                    <li><strong>Take Action:</strong> Contact vehicle owners and implement preventive measures</li>
                    <li><strong>Monitor Results:</strong> Track improvements and refine the model over time</li>
                </ol>
                <div class="mt-3">
                    <a href="{% url 'dashboard:prediction_analysis' %}" class="btn btn-primary">
                        <i class="fas fa-chart-line"></i> Run Prediction Analysis
                    </a>
                    <a href="{% url 'dashboard:risk_analysis' %}" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle"></i> View Risk Analysis
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

